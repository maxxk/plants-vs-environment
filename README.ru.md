# Симулятор растений Plants vs Environment

[In English](README.md)

![](gameplay.gif)

Вдохновлён, в некотором смысле, игрой [Dwarf Fortress](http://bay12games.com/dwarves/),
но задуман для обучения программированию в игровой форме.

Сейчас это просто игра-«песочница» в статусе технической демо-версии, без всяких обязательств по её развитию.

Двумерная карта состоит из пустого пространства и «почвы».
С верхней части карты выпускаются ресурсы («солнце» и «дождь»).
Растение состоит из независимых клеток.
Основные показатели растения: структура, энергия и вода.
У растения задана управляющая программа, которая вызывается на каждом шаге симуляции.

Растение постоянно тратит энергию на поддержание,
количество затрачиваемой энергии увеличивается в зависимости от
очков структуры и от сложности управляющей программы
(src/plant.js).
После исчерпания энергии штрафные очки отнимаются от очков структуры растения.

Растение может поймать «фотон»
и преобразовать 1 фотон и 1 единицу воды в энергию.
Клетка растения может разделиться на две с заданием
для новой клетки собственной программы и набора данных.
На все действия, примерный перечень которых приведён далее,
тратится определённое количество энергии.

На капли дождя действует гравитация, ветер, сопротивление воздуха и случайные импульсы от ветра
(src/systems.js).
На «фотоны» всё это не действует, но при столкновении с каплями
капли частично испаряются, на что тратится энергия фотонов.
Почва может промокать, влажность распространяется вглубь и в стороны.

## TODO

### Предполагается сделать

- [ ] третий ресурс — «глюкоза» для распространения энергии с возможностью передачи сообщений, или вместо этого добавить возможность испускать фотоны
- [ ] доделать ввод программы через редактор
- [ ] выделение клетки курсором и элементы управления клеткой
- [ ] ручное управление клеткой
- [ ] процедурная генерация ландшафта
- [ ] настройка параметров симуляции
- [ ] генерация клеткой своей картинки

### Можно было бы добавить в следующей версии, если бы она была

- [ ] «сюжет», сценарии обучения, миссии
- [ ] изменение погоды
- [ ] механика взаимодействия между клетками (стыковка, перемещение, воздействие гравитации и ветра, «одуванчики»)
- [ ] повреждение клетки из-за сухости или повышенной влажности
- [ ] специализация клеток с точки зрения эффективности отдельных действий? (скорее всего, слишком усложнит игру)
- [ ] MMO-элементы (например, случайные «загрязнения» клетками с другим кодом
или пересечения с чужими «мирами» по оси Z)
- [ ] вместо JavaScript использовать какой-нибудь машинный код (Forth-машина или DCPU-16) и списывать энергию за такты работы программы или исполнять определённое количество тактов программы за шаг симуляции
- [ ] «недружественные» взаимодействия между клетками (уничтожение, кража энергии)
- [ ] новый ресурс — «химические вещества» в почве
- [ ] автогенерация картинок по коду + даным (hash visualization)

## Управляющая программа

Управляющая программа клетки принимает 4 аргумента:

- static — основные показатели растения;
- data — данные, которые растение может сохранять;
- delta — время, прошедшее с момента предыдущего кадра;
- api — функции для взаимодействия с внешним миром.

Функции:

```typescript
type Controls = {
    // Поглотить ресурс или перевести структуру в энергию
    consume(kind: "sun" | "rain" | "structure", amount: number),
    // «Выстрелить» каплей воды или починиться
    produce(kind: "rain" | "structure", amount: number, velocity?: { x: number, y: number }),
    // Деление клетки
    split<T>(direction: { x: number, y: number }, static: { water: number, structure: number, energy: number }, data: T, code?: string),
    // Записать данные
    store(key: string, value: any),
    // Удалить данные (чтобы не тратить постоянную энергию на их поддержание)
    drop(key: string),
    // Получить информацию о ячейке карты относительно положения клетки
    getTile(direction: { x: number, y: number } ),
    // Получить список ресурсов и клеток, с которыми пересекается
    // квадрат со стороной width
    // по данному вектору относительно положения клетки
    getNearby(direction: { x: number, y: number }, width: number)
};
```

Простой пример управляющей программы:

```js
api.consume("rain", 1);
api.consume("sun", 2);
```

## Структура кода
Весь содержательный код находится в каталоге ./src
Для обзора кода с верхнего уровня можно начать с файла ./src/types.d.ts с определением основных типов.

В порядке загрузки:
- common.js ­— общая часть «движка» из примера с MDN
- util.js — вспомогательные функции
- map.js — генерация карты
- systems.js ­­­— физическая симуляция
- cell-code.js — контекст, в котором выполняется управляющая программа клетки
- plant-examples.js — примеры управляющих программ
- plant.js — вспомогательный код для клеток
- game.js — отрисовка и прокрутка

Компиляторы и упаковщики кода не используются чтобы не переусложнять.

## Лицензии
Код («движок») основан на примере из серии статей на MDN: https://github.com/mozdevs/gamedev-js-tiles

Новый код, как и оригинальный, распространяется по лицензии MPL2.

JavaScript-библиотеки:
- CodeMirror (текстовый редактор; лицензия MIT): https://codemirror.net/
- AcornJS (парсер JavaScript, для определения сложности программы растения; лицензция MIT): https://github.com/acornjs/acorn

Графические материалы:
- Карта assets/bloo.png: (chipmunk, лицензия OGA-BY 3.0) https://opengameart.org/content/platform-tileset-0
- Растение assets/generic-plant.png: (Matt Hackett of Lost Decade Games, лицензия CC-BY 3.0) https://opengameart.org/content/bomb-party
- Капли assets/orb*.png: https://www.piskelapp.com/p/agxzfnBpc2tlbC1hcHByEwsSBlBpc2tlbBiAgID4h730Cww/edit
https://www.piskelapp.com/p/agxzfnBpc2tlbC1hcHByEwsSBlBpc2tlbBiAgID4o-i4CAw/edit

